---
stages:
  - .pre
  - build_docker_images
  - push_docker_images
  - source
  - build
  - test
  - deploy
  - .post
variables:
  ASAN_OPTIONS: detect_stack_use_after_return=1,exitcode=42
  FF_TIMESTAMPS: 'true'
  UBSAN_OPTIONS: exitcode=42,print_stacktrace=1
pages:
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  script:
    - ci/pages.sh
    - echo "Preview:" "https://${CI_PROJECT_NAMESPACE}.${CI_PAGES_DOMAIN}/-/${CI_PROJECT_NAME}/-/jobs/${CI_JOB_ID}/artifacts/public/doxygen/index.html"
  artifacts:
    expire_in: 1 week
    paths:
      - public
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: ubuntu-24.04
  except:
    - tags
  only:
    - main
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
portable-source:
  needs:
    - job: docker_build_ubuntu-22.04
      artifacts: true
      optional: false
  stage: source
  tags:
    - saas-linux-small-amd64
  image:
    name: $CI_REGISTRY_IMAGE/ubuntu-22.04:$CI_COMMIT_SHA
  script:
    - ./autogen.sh
    - ./configure --enable-man-pdfs
    - make dist
    - make dist-xz
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - graphviz-*.tar.gz
      - graphviz-*.tar.xz
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
rocky8-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_rocky8
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky8
rocky9-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_rocky9
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky9
rocky10-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_rocky10
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky10
fedora41-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_fedora41
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora41
fedora42-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_fedora42
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora42
fedora43-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_fedora43
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora43
ubuntu-22.04-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-22.04
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-22.04
ubuntu-24.04-debug-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  before_script:
    - export CFLAGS="-DDEBUG"
    - export CXXFLAGS="-DDEBUG"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-24.04-static-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - export CONFIGURE_OPTIONS="--disable-shared --enable-static"
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-24.04-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-25.10-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-25.10
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-25.10
out-of-source-build:
  stage: build
  script:
    - logfile=`mktemp`
    - ci/out-of-source-build.sh |& tee $logfile
    - echo "$CI_JOB_NAME-warnings `grep -c 'warning:' $logfile`" | tee metrics.txt
  artifacts:
    when: on_success
    expire_in: 1 week
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
    - job: portable-source
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
macos-autotools-build:
  stage: build
  script:
    - source ci/macos-install-build-dependencies.sh
    - logfile=`mktemp`
    - ci/build.sh 2>&1 | tee $logfile
    - echo "$CI_JOB_NAME-warnings `grep -c 'warning:' $logfile`" | tee metrics.txt
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.zip
      - Packages/*/*.pkg
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: macos-14-xcode-15
  only:
    variables:
      - $ENABLE_GRAPHVIZ_MACOS_CI
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: portable-source
      artifacts: true
      optional: false
  before_script:
    - export build_system="autotools"
  tags:
    - saas-macos-medium-m1
windows-mingw64-build:
  stage: build
  needs:
    - job: portable-source
      artifacts: true
      optional: false
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ci\mingw-prepare.ps1
    - $Env:build_system = "autotools"
    - $Env:use_autogen = "yes"
    - C:\msys64\msys2_shell.cmd -defterm -mingw64 -here -no-start -l -c 'cd $CI_PROJECT_DIR && ci/mingw-build.sh'
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
windows-mingw64-static-build:
  stage: build
  needs:
    - job: portable-source
      artifacts: true
      optional: false
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ci\mingw-prepare.ps1
    - $Env:build_system = "autotools"
    - $Env:CONFIGURE_OPTIONS = "--disable-shared --enable-static"
    - $Env:use_autogen = "yes"
    - C:\msys64\msys2_shell.cmd -defterm -mingw64 -here -no-start -l -c 'cd $CI_PROJECT_DIR && ci/mingw-build.sh'
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
windows-cygwin-build:
  stage: build
  needs:
    - job: portable-source
      artifacts: true
      optional: false
  script:
    - $Env:CI_COMMIT_DESCRIPTION = $null
    - $Env:CI_COMMIT_MESSAGE = $null
    - $Env:CI_COMMIT_TITLE = $null
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - |
      $cygwinPath = "C:\cygwin64"
      $mirror = "https://mirrors.kernel.org"
      $mirrorHost = "mirrors.kernel.org"

      # 1. NETWORK CHECK
      if (-not (Test-NetConnection $mirrorHost -Port 443).TcpTestSucceeded) {
          Write-Error "Mirror $mirrorHost is unreachable. Installation likely to fail."
      }

      # 2. CLEANUP (Services & Processes)
      Write-Host "--- Cleaning Up Existing Cygwin ---"
      Get-Service | Where-Object { $_.Status -eq 'Running' } | ForEach-Object {
          $path = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$($_.Name)").ImagePath
          if ($path -like "*$cygwinPath*") { Stop-Service $_.Name -Force }
      }
      Get-Process | Where-Object { $_.Path -like "$cygwinPath*" } | Stop-Process -Force -EA 0

      # 3. FETCH INSTALLER RETRY LOOP
      $success = $false
      for ($i=1; $i -le 3; $i++) {
          Write-Host "Cygwin Setup Attempt $i..."
          wget https://cygwin.com/setup-x86_64.exe -OutFile C:\setup-x86_64.exe
          if ($p.ExitCode -eq 0) { $success = $true; break }
          Write-Warning "Attempt $i failed (Code: $($p.ExitCode)). Sleeping 7s..."
          Start-Sleep -Seconds 7
      }

      if (-not $success) {
          Write-Error "Cygwin installater download failed after 3 attempts."
          $global::diag_needed = $true
      }

      # 4. INSTALL CYGWIN RETRY LOOP
      $success = $false
      for ($i=1; $i -le 3; $i++) {
          Write-Host "Cygwin Setup Attempt $i..."
          $p = Start-Process "C:\setup-x86_64.exe" -ArgumentList "--quiet-mode --site $mirror --wait" -Wait -PassThru
          if ($p.ExitCode -eq 0) { $success = $true; break }
          Write-Warning "Attempt $i failed (Code: $($p.ExitCode)). Sleeping 15s..."
          Start-Sleep -Seconds 15
      }

      if (-not $success) {
          Write-Error "Cygwin installation failed after 3 attempts."
          $global::diag_needed = $true
      }
    - if ($global:diag_needed) { !reference [.network_diag_logic, script]
    - if ($global:diag_needed) { exit 1}
    - Remove-Item -Path 'C:\Python313' -Recurse -Force
    - $Env:Path = "C:\cygwin64\bin;" + $Env:Path
    - $Env:CFLAGS = "-Werror -Wno-error=implicit-fallthrough"
    - $Env:CXXFLAGS = "-Werror"
    - C:\cygwin64\bin\sed -i 's/\r//g' ci/*.sh
    - $Env:build_system = "autotools"
    - C:\cygwin64\bin\bash -l -c 'cd $CI_PROJECT_DIR && ci/cygwin-build.sh'
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - Packages/*/*.xz
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
windows-cygwin-build-using-autogen:
  stage: build
  needs: []
  script:
    - $Env:CI_COMMIT_DESCRIPTION = $null
    - $Env:CI_COMMIT_MESSAGE = $null
    - $Env:CI_COMMIT_TITLE = $null
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - |
      $cygwinPath = "C:\cygwin64"
      $mirror = "https://mirrors.kernel.org"
      $mirrorHost = "mirrors.kernel.org"

      # 1. NETWORK CHECK
      if (-not (Test-NetConnection $mirrorHost -Port 443).TcpTestSucceeded) {
          Write-Error "Mirror $mirrorHost is unreachable. Installation likely to fail."
      }

      # 2. CLEANUP (Services & Processes)
      Write-Host "--- Cleaning Up Existing Cygwin ---"
      Get-Service | Where-Object { $_.Status -eq 'Running' } | ForEach-Object {
          $path = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$($_.Name)").ImagePath
          if ($path -like "*$cygwinPath*") { Stop-Service $_.Name -Force }
      }
      Get-Process | Where-Object { $_.Path -like "$cygwinPath*" } | Stop-Process -Force -EA 0

      # 3. FETCH INSTALLER RETRY LOOP
      $success = $false
      for ($i=1; $i -le 3; $i++) {
          Write-Host "Cygwin Setup Attempt $i..."
          wget https://cygwin.com/setup-x86_64.exe -OutFile C:\setup-x86_64.exe
          if ($p.ExitCode -eq 0) { $success = $true; break }
          Write-Warning "Attempt $i failed (Code: $($p.ExitCode)). Sleeping 7s..."
          Start-Sleep -Seconds 7
      }

      if (-not $success) {
          Write-Error "Cygwin installater download failed after 3 attempts."
          $global::diag_needed = $true
      }

      # 4. INSTALL CYGWIN RETRY LOOP
      $success = $false
      for ($i=1; $i -le 3; $i++) {
          Write-Host "Cygwin Setup Attempt $i..."
          $p = Start-Process "C:\setup-x86_64.exe" -ArgumentList "--quiet-mode --site $mirror --wait" -Wait -PassThru
          if ($p.ExitCode -eq 0) { $success = $true; break }
          Write-Warning "Attempt $i failed (Code: $($p.ExitCode)). Sleeping 15s..."
          Start-Sleep -Seconds 15
      }

      if (-not $success) {
          Write-Error "Cygwin installation failed after 3 attempts."
          $global::diag_needed = $true
      }
    - if ($global:diag_needed) { !reference [.network_diag_logic, script]
    - if ($global:diag_needed) { exit 1}
    - Remove-Item -Path 'C:\Python313' -Recurse -Force
    - $Env:Path = "C:\cygwin64\bin;" + $Env:Path
    - C:\cygwin64\bin\find . '(' -name Makefile.am -or -name "*.def" ')' -exec C:\cygwin64\bin\sed -i 's/\r//g' "{}" ';'
    - C:\cygwin64\bin\sed -i 's/\r//g' autogen.sh ci/*.sh configure.ac lib/common/color_names lib/common/brewer_colors lib/common/svgcolor_names
    - $Env:build_system = "autotools"
    - C:\cygwin64\bin\bash -l -c 'cd $CI_PROJECT_DIR && ci/cygwin-build.sh'
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
ubuntu-22.04-cmake-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-22.04
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="-Dwith_cxx_api=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_SMYRNA=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-22.04
ubuntu-24.04-cmake-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_SMYRNA=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-25.10-cmake-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-25.10
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_SMYRNA=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_RUBY=OFF"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-25.10
ubuntu-24.04-cmake-minimal-build:
  stage: build
  script:
    - source /opt/virtualenv/bin/activate
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*deb
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS=""
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -Dwith_digcola=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -Dwith_ipsepcola=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -Dwith_ortho=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -Dwith_sfdp=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_SMYRNA=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_TCL=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_SWIG=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GDK=OFF"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-24.04-cmake-ASan-build-and-test-including-ctest:
  stage: build
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: false
      optional: false
  script:
    - source /opt/virtualenv/bin/activate
    - export build_system="cmake"
    - export CFLAGS="-fno-omit-frame-pointer -fsanitize=address,undefined -fno-sanitize-recover=address,undefined -g -Werror"
    - export CXXFLAGS="-fno-omit-frame-pointer -fsanitize=address,undefined -fno-sanitize-recover=address,undefined -g -Werror -DBOOST_ALLOW_DEPRECATED_HEADERS"
    - export LDFLAGS="-fno-omit-frame-pointer -fsanitize=address,undefined -fno-sanitize-recover=address,undefined -g -Werror"
    - export CMAKE_OPTIONS="-Duse_coverage=ON -Dwith_cxx_tests=ON -Dwith_cxx_api=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_SMYRNA=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
    - ci/linux-build-job-script.sh
    - echo 'leak:*libfontconfig*' > suppressions.txt
    - export LSAN_OPTIONS=suppressions=$(pwd)/suppressions.txt
    - ci/linux-test-including-ctest-job-script.sh
  coverage: '/  lines\.{6}: \d+\.\d+%/'
  artifacts:
    paths:
      - coverage/**
      - build/tests/test_artifacts/**
    reports:
      junit:
        - ./report.xml
        - build/tests/test_*.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      metrics: metrics.txt
  except:
    - tags
  tags:
    - saas-linux-small-amd64
  image:
    name: $CI_REGISTRY_IMAGE/ubuntu-24.04:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
rocky8-cmake-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_rocky8
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror -Wno-error=missing-braces"
    - export CXXFLAGS="-Werror -Wno-error=missing-braces"
    - export CMAKE_OPTIONS="-DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky8
rocky9-cmake-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_rocky9
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror -Wno-error=missing-braces"
    - export CXXFLAGS="-Werror -Wno-error=missing-braces"
    - export CMAKE_OPTIONS="-DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky9
rocky10-cmake-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_rocky10
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror -Wno-error=missing-braces"
    - export CXXFLAGS="-Werror -Wno-error=missing-braces"
    - export CMAKE_OPTIONS="-DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky10
fedora41-cmake-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_fedora41
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="-DWITH_SMYRNA=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora41
fedora42-cmake-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_fedora42
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="-DWITH_SMYRNA=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora42
fedora43-cmake-build:
  stage: build
  script:
    - ci/linux-build-job-script.sh
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.tar.xz
      - Packages/*/*.rpm
      - Metadata/*/*/configure.log
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs:
    - job: docker_build_fedora43
      artifacts: false
      optional: false
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="-DWITH_SMYRNA=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora43
macos-cmake-build:
  stage: build
  script:
    - source ci/macos-install-build-dependencies.sh
    - logfile=`mktemp`
    - ci/build.sh 2>&1 | tee $logfile
    - echo "$CI_JOB_NAME-warnings `grep -c 'warning:' $logfile`" | tee metrics.txt
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.zip
      - Packages/*/*.pkg
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: macos-14-xcode-15
  only:
    variables:
      - $ENABLE_GRAPHVIZ_MACOS_CI
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs: []
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror -Wno-error=implicit-fallthrough"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="-Dwith_cxx_api=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_QUARTZ=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_RUBY=OFF"
  tags:
    - saas-macos-medium-m1
macos-cmake-static-build:
  stage: build
  script:
    - source ci/macos-install-build-dependencies.sh
    - logfile=`mktemp`
    - ci/build.sh 2>&1 | tee $logfile
    - echo "$CI_JOB_NAME-warnings `grep -c 'warning:' $logfile`" | tee metrics.txt
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.zip
      - Packages/*/*.pkg
    reports:
      metrics: metrics.txt
  except:
    - tags
  image:
    name: macos-14-xcode-15
  only:
    variables:
      - $ENABLE_GRAPHVIZ_MACOS_CI
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  needs: []
  before_script:
    - export build_system="cmake"
    - export CFLAGS="-Werror -Wno-error=implicit-fallthrough"
    - export CXXFLAGS="-Werror"
    - export CMAKE_OPTIONS="-Dwith_cxx_api=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_LTDL=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_EXPAT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_GVEDIT=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_QUARTZ=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DWITH_ZLIB=ON"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_RUBY=OFF"
    - export CMAKE_OPTIONS="$CMAKE_OPTIONS -DBUILD_SHARED_LIBS=OFF"
  tags:
    - saas-macos-medium-m1
windows-cmake-Win32-release-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.exe
      - Packages/*/*.zip
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "Win32"
    - $Env:configuration = "Release"
    - $Env:BUILD_SHARED_LIBS = "ON"
windows-cmake-Win32-debug-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.exe
      - Packages/*/*.zip
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "Win32"
    - $Env:configuration = "Debug"
    - $Env:BUILD_SHARED_LIBS = "ON"
windows-cmake-x64-release-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.exe
      - Packages/*/*.zip
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "x64"
    - $Env:configuration = "Release"
    - $Env:BUILD_SHARED_LIBS = "ON"
windows-cmake-x64-debug-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - Packages/*/*.exe
      - Packages/*/*.zip
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "x64"
    - $Env:configuration = "Debug"
    - $Env:BUILD_SHARED_LIBS = "ON"
windows-cmake-Win32-asan-debug-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "Win32"
    - $Env:configuration = "Debug"
    - $Env:BUILD_SHARED_LIBS = "ON"
    - $Env:CFLAGS = "-fsanitize=address"
    - $Env:CXXFLAGS = "-fsanitize=address"
    - $msvc_path = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC"
    - $msvc_version = & invoke-Expression "Get-ChildItem -Path '$msvc_path' -Name"
    - $Env:Path += ";$msvc_path\$msvc_version\bin\Hostx64\x86"
  timeout: 2 hours
windows-cmake-x64-asan-debug-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "x64"
    - $Env:configuration = "Debug"
    - $Env:BUILD_SHARED_LIBS = "ON"
    - $Env:CFLAGS = "-fsanitize=address"
    - $Env:CXXFLAGS = "-fsanitize=address"
    - $msvc_path = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC"
    - $msvc_version = & invoke-Expression "Get-ChildItem -Path '$msvc_path' -Name"
    - $Env:Path += ";$msvc_path\$msvc_version\bin\Hostx64\x64"
  timeout: 2 hours
windows-cmake-x64-debug-static-build:
  stage: build
  needs: []
  script:
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - $ErrorActionPreference = "Stop"
    - $PSDefaultParameterValues['*:ErrorAction']='Stop'
    - Add-MpPreference -ExclusionPath 'C:\'
    - $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
    - python --version
    - if (-not $?) { throw "command failed" }
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Set-ExecutionPolicy Bypass -Force -Scope Process
    - python ci/windows_build.py --platform $Env:project_platform --configuration $Env:configuration --build-shared-libs=$Env:BUILD_SHARED_LIBS
    - if (-not $?) { throw "command failed" }
  artifacts:
    when: on_success
    expire_in: 1 week
    reports:
      metrics: metrics.txt
      junit: report.xml
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - $Env:project_platform = "x64"
    - $Env:configuration = "Debug"
    - $Env:BUILD_SHARED_LIBS = "OFF"
windows-mingw64-cmake-build:
  stage: build
  needs: []
  script:
    - Add-MpPreference -ExclusionPath 'C:\'
    - powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ci\mingw-prepare.ps1
    - $Env:build_system = "cmake"
    - C:\msys64\msys2_shell.cmd -defterm -mingw64 -here -no-start -l -c 'cd $CI_PROJECT_DIR && ci/mingw-build.sh'
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - Packages/*/*.exe
      - Packages/*/*.zip
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
windows-mingw64-cmake-release-build:
  stage: build
  needs: []
  script:
    - Add-MpPreference -ExclusionPath 'C:\'
    - powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ci\mingw-prepare.ps1
    - $Env:build_system = "cmake"
    - $Env:CMAKE_OPTIONS = "-DCMAKE_BUILD_TYPE=Release"
    - C:\msys64\msys2_shell.cmd -defterm -mingw64 -here -no-start -l -c 'cd $CI_PROJECT_DIR && ci/mingw-build.sh'
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
windows-cygwin-cmake-build:
  stage: build
  needs: []
  script:
    - $Env:CI_COMMIT_DESCRIPTION = $null
    - $Env:CI_COMMIT_MESSAGE = $null
    - $Env:CI_COMMIT_TITLE = $null
    - |
      # 1. HEALTH REPORT
      Write-Host "--- Runner Health ---"
      Get-PSDrive C | Select-Object @{N="FreeGB";E={[math]::round($_.Free/1GB,2)}} | Out-Host
      $mem = Get-CimInstance Win32_OperatingSystem
      Write-Host "Free Memory: $([math]::round($mem.FreePhysicalMemory/1MB, 2)) GB"
      # 2. disable Windows Defender
      Add-MpPreference -ExclusionPath 'C:\'
    - |
      $cygwinPath = "C:\cygwin64"
      $mirror = "https://mirrors.kernel.org"
      $mirrorHost = "mirrors.kernel.org"

      # 1. NETWORK CHECK
      if (-not (Test-NetConnection $mirrorHost -Port 443).TcpTestSucceeded) {
          Write-Error "Mirror $mirrorHost is unreachable. Installation likely to fail."
      }

      # 2. CLEANUP (Services & Processes)
      Write-Host "--- Cleaning Up Existing Cygwin ---"
      Get-Service | Where-Object { $_.Status -eq 'Running' } | ForEach-Object {
          $path = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$($_.Name)").ImagePath
          if ($path -like "*$cygwinPath*") { Stop-Service $_.Name -Force }
      }
      Get-Process | Where-Object { $_.Path -like "$cygwinPath*" } | Stop-Process -Force -EA 0

      # 3. FETCH INSTALLER RETRY LOOP
      $success = $false
      for ($i=1; $i -le 3; $i++) {
          Write-Host "Cygwin Setup Attempt $i..."
          wget https://cygwin.com/setup-x86_64.exe -OutFile C:\setup-x86_64.exe
          if ($p.ExitCode -eq 0) { $success = $true; break }
          Write-Warning "Attempt $i failed (Code: $($p.ExitCode)). Sleeping 7s..."
          Start-Sleep -Seconds 7
      }

      if (-not $success) {
          Write-Error "Cygwin installater download failed after 3 attempts."
          $global::diag_needed = $true
      }

      # 4. INSTALL CYGWIN RETRY LOOP
      $success = $false
      for ($i=1; $i -le 3; $i++) {
          Write-Host "Cygwin Setup Attempt $i..."
          $p = Start-Process "C:\setup-x86_64.exe" -ArgumentList "--quiet-mode --site $mirror --wait" -Wait -PassThru
          if ($p.ExitCode -eq 0) { $success = $true; break }
          Write-Warning "Attempt $i failed (Code: $($p.ExitCode)). Sleeping 15s..."
          Start-Sleep -Seconds 15
      }

      if (-not $success) {
          Write-Error "Cygwin installation failed after 3 attempts."
          $global::diag_needed = $true
      }
    - if ($global:diag_needed) { !reference [.network_diag_logic, script]
    - if ($global:diag_needed) { exit 1}
    - Remove-Item -Path 'C:\Python313' -Recurse -Force
    - $Env:Path = "C:\cygwin64\bin;" + $Env:Path
    - $Env:CFLAGS = "-Werror -Wno-error=implicit-fallthrough"
    - $Env:CXXFLAGS = "-Werror"
    - C:\cygwin64\bin\sed -i 's/\r//g' ci/*.sh lib/common/color_names lib/common/brewer_colors lib/common/svgcolor_names
    - $Env:build_system = "cmake"
    - C:\cygwin64\bin\bash -l -c 'cd $CI_PROJECT_DIR && ci/cygwin-build.sh'
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - Packages/*/*.bz2
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
meta-data:
  stage: test
  script:
    - CONFIGURE_LOGS=Metadata/*/*/configure.log
    - ci/generate_configuration_table.py ${CONFIGURE_LOGS} > configuration-long-no-color.html
    - ci/generate_configuration_table.py --short ${CONFIGURE_LOGS} > configuration-short-no-color.html
    - ci/generate_configuration_table.py --short --color ${CONFIGURE_LOGS} > configuration-short-color-green-red.html
    - ci/generate_configuration_table.py --short --colors black:red ${CONFIGURE_LOGS} > configuration-short-color-red-only.html
  artifacts:
    paths:
      - configuration-*.html
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
ubuntu-22.04-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: ubuntu-22.04-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-22.04
ubuntu-24.04-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: ubuntu-24.04-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-25.10-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: ubuntu-25.10-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-25.10
rocky8-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: rocky8-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky8
rocky9-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: rocky9-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky9
rocky10-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: rocky10-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky10
fedora41-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: fedora41-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora41
fedora42-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: fedora42-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora42
fedora43-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="autotools"
  needs:
    - job: fedora43-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora43
macos-autotools-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - source ci/macos-install-runtime-dependencies.sh
    - export build_system="autotools"
  needs:
    - job: macos-autotools-build
      artifacts: true
      optional: false
  tags:
    - saas-macos-medium-m1
  image:
    name: macos-14-xcode-15
  only:
    variables:
      - $ENABLE_GRAPHVIZ_MACOS_CI
ubuntu-22.04-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: ubuntu-22.04-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-22.04
ubuntu-24.04-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: ubuntu-24.04-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-24.04
ubuntu-25.10-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: ubuntu-25.10-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: ubuntu-25.10
rocky8-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: rocky8-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky8
rocky9-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: rocky9-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky9
rocky10-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: rocky10-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: rocky10
fedora41-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: fedora41-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora41
fedora42-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: fedora42-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora42
fedora43-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  image:
    name: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  before_script:
    - export build_system="cmake"
  needs:
    - job: fedora43-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  variables:
    IMAGE: fedora43
macos-cmake-test:
  stage: test
  script:
    - source /opt/virtualenv/bin/activate
    - ci/test-job-script.sh
  artifacts:
    reports:
      junit: report.xml
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  before_script:
    - source ci/macos-install-runtime-dependencies.sh
    - export build_system="cmake"
  needs:
    - job: macos-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-macos-medium-m1
  image:
    name: macos-14-xcode-15
  only:
    variables:
      - $ENABLE_GRAPHVIZ_MACOS_CI
windows-mingw64-cmake-test:
  script:
    - Add-MpPreference -ExclusionPath 'C:\'
    - powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command ci\mingw-prepare.ps1
    - $Env:build_system = "cmake"
    - C:\msys64\msys2_shell.cmd -defterm -mingw64 -here -no-start -l -c 'cd $CI_PROJECT_DIR && ci/mingw-install.sh'
    - $Env:graphviz_install_dir = "C:\Graphviz"
    - Invoke-Expression "./Packages/windows-mingw64-cmake-build/*.exe /S /D=$Env:graphviz_install_dir" | Out-Null
    - $Env:Path = $Env:graphviz_install_dir + "\bin" + ";" + $Env:Path
    - C:\msys64\msys2_shell.cmd -defterm -mingw64 -here -no-start -l -c 'cd $CI_PROJECT_DIR && ci/mingw-test.sh'
  needs:
    - job: windows-mingw64-cmake-build
      artifacts: true
      optional: false
  tags:
    - saas-windows-medium-amd64
  except:
    - tags
  artifacts:
    reports:
      junit: report.xml
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
deployment:
  stage: deploy
  image:
    name: registry.gitlab.com/gitlab-org/release-cli:latest@sha256:3f52d526f48e8d10625c722fa6d6423ee82aadeae1b1aa91f07b62551d96dacf
  except:
    - tags
  before_script:
    - apk add --update-cache curl
    - apk add --update-cache python3
  script:
    - python3 ci/deploy.py
  only:
    - main@graphviz/graphviz
  artifacts:
    when: on_success
    expire_in: 1 week
    paths:
      - graphviz-*.json
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
docker_build_rocky8:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: rocky8
docker_build_rocky9:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: rocky9
docker_build_rocky10:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: rocky10
docker_build_fedora41:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: fedora41
docker_build_fedora42:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: fedora42
docker_build_fedora43:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: fedora43
docker_build_ubuntu-22.04:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: ubuntu-22.04
docker_build_ubuntu-24.04:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: ubuntu-24.04
docker_build_ubuntu-25.10:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: build_docker_images
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:latest || true
    - >-
      DOCKER_BUILDKIT=1 docker build -t $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA --cache-from $CI_REGISTRY_IMAGE/$IMAGE:latest -f ci/$IMAGE/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1 .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
  variables:
    IMAGE: ubuntu-25.10
docker_push_rocky8:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: rocky8
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_rocky8
      artifacts: true
      optional: false
docker_push_rocky9:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: rocky9
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_rocky9
      artifacts: true
      optional: false
docker_push_rocky10:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: rocky10
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_rocky10
      artifacts: true
      optional: false
docker_push_fedora41:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: fedora41
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_fedora41
      artifacts: true
      optional: false
docker_push_fedora42:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: fedora42
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_fedora42
      artifacts: true
      optional: false
docker_push_fedora43:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: fedora43
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_fedora43
      artifacts: true
      optional: false
docker_push_ubuntu-22.04:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: ubuntu-22.04
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_ubuntu-22.04
      artifacts: true
      optional: false
docker_push_ubuntu-24.04:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: ubuntu-24.04
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_ubuntu-24.04
      artifacts: true
      optional: false
docker_push_ubuntu-25.10:
  image:
    name: docker:29.0.0-cli@sha256:87858a6dd14149240f4a2c33e0ec0f32a5ac1bb2548c04f5a20694ea25cb6157
  services:
    - name: docker:29.0.0-dind@sha256:96789d56621ae702a2f8aa316c87a1a1875dd3f02bf67cdcb56a524a09fa3af9
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
  stage: push_docker_images
  variables:
    IMAGE: ubuntu-25.10
  only:
    refs:
      - main
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/$IMAGE:latest
    - docker push     $CI_REGISTRY_IMAGE/$IMAGE:latest
  needs:
    - job: docker_build_ubuntu-25.10
      artifacts: true
      optional: false
lint_clang_format:
  stage: test
  needs: []
  script:
    - env DEBIAN_FRONTEND=noninteractive apt-get update -y
    - env DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y clang-format-19
    - clang-format-19 --version
    - cat /etc/os-release
    - uname -rms
    - python3 ci/clang_format.py
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
lint_cpplint:
  stage: test
  needs: []
  script:
    - env DEBIAN_FRONTEND=noninteractive apt-get update -y
    - env DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y cpplint
    - cpplint --version
    - cat /etc/os-release
    - uname -rms
    - git ls-files -z -- lib/cgraph++ lib/gvc++ | xargs -0 -- cpplint
    - git ls-files -z -- lib/xdot | xargs -0 -- cpplint --filter=-readability/casting
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
lint_cmake_format:
  stage: test
  needs: []
  script:
    - env DEBIAN_FRONTEND=noninteractive apt-get update -y
    - env DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y python3-venv
    - python3 --version
    - cat /etc/os-release
    - uname -rms
    - python3 -m venv /opt/virtualenv
    - source /opt/virtualenv/bin/activate
    - python3 -m pip install uv
    - python3 -m uv pip install --requirement requirements.txt
    - python3 -m uv pip install --requirement doc/infosrc/requirements.txt
    - git ls-files -z -- ':(glob)**/CMakeLists.txt' ':(glob)**/*.cmake' ':(glob)**/*.cmake.in' | xargs -0 -- python3 -m cmakelang.lint
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
lint_html:
  stage: test
  needs: []
  script:
    - env DEBIAN_FRONTEND=noninteractive apt-get update -y
    - env DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y libxml2-utils
    - xmllint --version
    - cat /etc/os-release
    - uname -rms
    - git ls-files -z -- '**/*.html' | xargs -0 -- xmllint --nonet --noout --html --valid
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
lint_python:
  image:
    name: $CI_REGISTRY_IMAGE/ubuntu-24.04:$CI_COMMIT_SHA
  stage: test
  needs:
    - job: ubuntu-24.04-build
      artifacts: true
      optional: false
  tags:
    - saas-linux-small-amd64
  before_script:
    - export build_system="autotools"
  script:
    - echo 'include-system-site-packages = true' >> /opt/virtualenv/pyvenv.cfg
    - source /opt/virtualenv/bin/activate
    - ci/install-packages.sh
    - python3 --version
    - cat /etc/os-release
    - uname -rms
    - git ls-files -z -- cmd/dot/dot_sandbox '**.py' | xargs -0 -- python3 -m pylint --rcfile=.pylintrc --disable=fixme
    - git ls-files -z -- cmd/dot/dot_sandbox '**.py' | xargs -0 -- python3 -m black --check
    - git ls-files -z -- cmd/dot/dot_sandbox '**.py' | xargs -0 -- python3 -m isort --profile=black --check
  except:
    - tags
  retry:
    max: 1
    when:
      - stuck_or_timeout_failure
      - runner_system_failure
      - job_execution_timeout
